name: Yandex Music Automation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  schedule:
    - cron: '0 */6 * * *' # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤

jobs:
  start-yandex-music:
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: üì¶ Install dependencies
      run: |
        npm install
      shell: pwsh
      
    - name: üö´ Kill existing processes (cleanup)
      run: |
        taskkill /F /IM "YandexMusic.exe" 2>nul || echo "Yandex Music not running"
        taskkill /F /IM "node.exe" 2>nul || echo "Node processes cleaned"
      shell: cmd
      
    - name: ‚ñ∂Ô∏è Start Yandex Music with debugging
      run: |
        # –ù–∞—Ö–æ–¥–∏–º –ø—É—Ç—å –∫ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞
        $musicPath = "$env:LOCALAPPDATA\Yandex\YandexMusic\application\YandexMusic.exe"
        
        if (Test-Path $musicPath) {
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ —Å –æ—Ç–ª–∞–¥–∫–æ–π..."
          Start-Process -FilePath $musicPath -ArgumentList "--remote-debugging-port=9222"
          Start-Sleep -Seconds 5
        } else {
          echo "‚ö†Ô∏è –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø—É—Ç–∏: $musicPath"
          echo "üîç –ò—â–µ–º –≤ –¥—Ä—É–≥–∏—Ö —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è—Ö..."
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏
          $paths = @(
            "$env:APPDATA\Yandex\YandexMusic\YandexMusic.exe",
            "$env:PROGRAMFILES\Yandex\YandexMusic\YandexMusic.exe",
            "$env:PROGRAMFILES(X86)\Yandex\YandexMusic\YandexMusic.exe"
          )
          
          foreach ($path in $paths) {
            if (Test-Path $path) {
              echo "‚úÖ –ù–∞–π–¥–µ–Ω–æ: $path"
              Start-Process -FilePath $path -ArgumentList "--remote-debugging-port=9222"
              Start-Sleep -Seconds 5
              break
            }
          }
        }
      shell: pwsh
      
    - name: üì° Run setup.js and servers
      run: |
        echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."
        timeout /t 10 /nobreak
        
        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä—ã..."
        call start.bat
      shell: cmd
      
    - name: üß™ Test connection
      run: |
        echo "üß™ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP —Å–µ—Ä–≤–µ—Ä–∞
        $httpTest = Invoke-WebRequest -Uri "http://localhost:3002" -Method GET -TimeoutSec 5 -ErrorAction SilentlyContinue
        if ($httpTest.StatusCode -eq 200) {
          echo "‚úÖ HTTP —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3002"
        } else {
          echo "‚ùå HTTP —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
        }
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket
        try {
          $wsTest = New-Object System.Net.Sockets.TcpClient
          $wsTest.Connect("localhost", 3002)
          if ($wsTest.Connected) {
            echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 3002"
            $wsTest.Close()
          }
        } catch {
          echo "‚ùå WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
        }
      shell: pwsh
      
    - name: üìä Display status
      run: |
        echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
        tasklist | findstr /i "YandexMusic node"
        
        echo ""
        echo "üåê –°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
        netstat -an | findstr ":3002 :9222"
      shell: cmd
