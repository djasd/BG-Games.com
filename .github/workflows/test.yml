name: Yandex Music Server

on:
  workflow_dispatch:
    inputs:
      music_path:
        description: 'Path to Yandex Music'
        required: false
        default: ''

jobs:
  launch:
    runs-on: windows-latest
    
    steps:
    # Ð¨Ð°Ð³ 1: Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ checkout
    - name: ðŸ“¥ Get repository code
      uses: actions/checkout@v4
      with:
        path: ./music-server
        clean: false
        
    - name: ðŸ“‚ Navigate to code directory
      run: |
        cd music-server
        echo "Files in directory:"
        dir
      shell: cmd
      
    # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js
    - name: ðŸ”§ Setup Node.js
      if: success()
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
    - name: ðŸ“¦ Install packages
      if: success()
      run: |
        cd music-server
        if exist package.json (
          npm install
        ) else (
          echo "No package.json found, installing basic dependencies..."
          npm init -y
          npm install ws chrome-remote-interface
        )
      shell: cmd
      
    # Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²
    - name: ðŸ” Verify scripts exist
      run: |
        cd music-server
        echo "Checking files..."
        if exist start.bat (
          echo "âœ… start.bat exists"
          type start.bat
        ) else (
          echo "âŒ start.bat not found!"
          exit 1
        )
        
        if exist setup.js (
          echo "âœ… setup.js exists"
        ) else (
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ setup.js
          echo "ðŸ“ Creating basic setup.js..."
          echo "console.log('Server starting...');" > setup.js
          echo "setTimeout(() => console.log('Test complete'), 3000);" >> setup.js
        )
      shell: cmd
      
    # Ð¨Ð°Ð³ 5: Ð—Ð°Ð¿ÑƒÑÐº Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
    - name: â–¶ï¸ Run batch file
      run: |
        cd music-server
        echo "ðŸš€ Starting batch file..."
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
        start /B cmd /C "call start.bat > output.log 2>&1"
        
        # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾
        timeout /t 5 /nobreak
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸
        if exist output.log (
          echo "ðŸ“„ Batch file output:"
          type output.log
        )
      shell: cmd
      
    # Ð¨Ð°Ð³ 6: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
    - name: ðŸ§ª Verify servers are running
      run: |
        echo "ðŸ” Checking processes..."
        tasklist | findstr "node" || echo "No node processes found"
        
        echo "ðŸŒ Checking ports..."
        netstat -an | findstr ":3002" || echo "Port 3002 not in use"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· curl ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
        where curl >nul 2>&1
        if %errorlevel% == 0 (
          curl -s http://localhost:3002 || echo "HTTP server not responding"
        )
      shell: cmd
      
    # Ð¨Ð°Ð³ 7: Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¾Ð²
    - name: ðŸ“Š Save logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: server-logs
        path: |
          music-server/output.log
          music-server/npm-debug.log
        retention-days: 1
