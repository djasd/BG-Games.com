name: Yandex Music Remote Server

on:
  workflow_dispatch: # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
    inputs:
      headless:
        description: '–ó–∞–ø—É—Å–∫ –±–µ–∑ GUI'
        required: false
        default: 'true'
        type: boolean

jobs:
  remote-yandex-music:
    runs-on: windows-latest
    
    env:
      YANDEX_MUSIC_PORT: 9222
      SERVER_PORT: 3002
      HEADLESS: ${{ github.event.inputs.headless }}
      
    steps:
    - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üü¢ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        if exist package.json (
          npm ci
        ) else (
          # –£—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
          npm init -y
          npm install ws axios puppeteer
        )
        
    - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É..."
        ping -n 3 music.yandex.ru
        curl --connect-timeout 10 -I https://music.yandex.ru || echo "Curl —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω"
        
    - name: üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
      run: |
        echo "–ó–∞–ø—É—Å–∫ start.bat..."
        echo "–ü–æ—Ä—Ç –æ—Ç–ª–∞–¥–∫–∏ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞: %YANDEX_MUSIC_PORT%"
        echo "–ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞: %SERVER_PORT%"
        echo "–†–µ–∂–∏–º –±–µ–∑ GUI: %HEADLESS%"
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
        start /B cmd /c "start.bat"
        
        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
        timeout /t 15
      shell: cmd
      
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ==="
        tasklist | findstr /i "node chrome"
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤ ==="
        netstat -ano | findstr ":%SERVER_PORT%"
        netstat -ano | findstr ":%YANDEX_MUSIC_PORT%"
        
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç ==="
        powershell -Command "
          try {
            \$status = (Test-NetConnection music.yandex.ru -Port 443).TcpTestSucceeded
            Write-Output '‚úÖ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ –¥–æ—Å—Ç—É–ø–µ–Ω: ' + \$status
          } catch {
            Write-Output '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏'
          }
        "
        
    - name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP —Å–µ—Ä–≤–µ—Ä–∞
      run: |
        echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä..."
        powershell -Command "
          \$maxRetries = 10
          \$retryDelay = 3
          
          for (\$i = 1; \$i -le \$maxRetries; \$i++) {
            Write-Host '–ü–æ–ø—ã—Ç–∫–∞ \$i –∏–∑ \$maxRetries...'
            
            try {
              \$response = Invoke-WebRequest -Uri 'http://localhost:${{ env.SERVER_PORT }}' -TimeoutSec 5
              Write-Host '‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç! –°—Ç–∞—Ç—É—Å: ' \$response.StatusCode
              Write-Host '–û—Ç–≤–µ—Ç: ' \$response.Content
              exit 0
            } catch {
              Write-Host '‚ùå –û—à–∏–±–∫–∞: ' \$_.Exception.Message
              
              if (\$i -lt \$maxRetries) {
                Write-Host '–ñ–¥–µ–º \$retryDelay —Å–µ–∫—É–Ω–¥...'
                Start-Sleep -Seconds \$retryDelay
              }
            }
          }
          
          Write-Host '‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –ø–æ—Å–ª–µ \$maxRetries –ø–æ–ø—ã—Ç–æ–∫'
          exit 1
        "
