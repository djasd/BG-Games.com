<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>OBS Widget - Обложка трека</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: transparent;
        }

        .cover-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #albumArt {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        #albumArt.visible {
            opacity: 1;
            transform: scale(1);
        }

        #placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            color: #bbbbbb;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>

<div class="cover-container">
    <div id="placeholder">Ожидание...</div>
    <img id="albumArt" src="">
</div>

<script>
    let ws = null;
    let reconnectInterval;

    function connect() {
        const savedSettings = localStorage.getItem('yandexMusicSettings');
        let settings = {
            local: { ip: '192.168.1.100', wsPort: '3003', token: 'yandex-music-token' },
            mode: 'local'
        };

        if (savedSettings) {
            try {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            } catch (e) {
                console.error("Ошибка парсинга настроек:", e);
            }
        }

        const wsUrl = settings.mode === 'mobile' && settings.mobile.url
            ? settings.mobile.url.replace(/^http/, 'ws') + `?token=${settings.mobile.token}`
            : `ws://${settings.local.ip}:${settings.local.wsPort}?token=${settings.local.token}`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('Виджет обложки подключен.');
            clearInterval(reconnectInterval);
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.command === 'status' || data.track) {
                updateWidget(data.track);
            }
        };

        ws.onclose = () => {
            console.log('Соединение потеряно. Переподключение...');
            if (!reconnectInterval) reconnectInterval = setInterval(connect, 5000);
        };

        ws.onerror = (error) => ws.close();
    }

    function updateWidget(track) {
        const albumArt = document.getElementById('albumArt');
        albumArt.src = (track && track.success && track.coverUrl) ? track.coverUrl : '';
        albumArt.classList.toggle('visible', !!(track && track.success && track.coverUrl));
    }

    document.addEventListener('DOMContentLoaded', connect);
</script>

</body>
</html>